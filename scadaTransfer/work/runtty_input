echo 'runtty_input started'
#keep hydromet files around as well
#rm hydromet_*
# run program to handle serial line communication and output file creation
tty_input
#echo ' '
echo ' '
echo '        Initiating program to load data into Oracle HDB'
echo ' ' 
#set $1 to first field in this file
set `cat ./crsp_file`
# application scadaTransfer is run using the applications role
# it has two arguments the name of the log file and the password
# this application can be run independant of this script
# if the log file needs to be edited, edit the file (correct the 
# data - then run the following executable (scadaTransfer)
echo 'Placing Data into HDB2'
scadaTransfer $1 app_user uchdb2
# now run the derivation app to place the data into r_day
derivation app_user uchdb2 & 
# This application takes a bit of time, so we put it in the background
# we do all the other processing, then wait(1) for the derivation app
# then we can run scadadata, and create the hydromet input file from HDB2
echo ' '
echo '       Transferring data to Flagstaff'
echo ' '
ftp_orca
#rm hydromet_*
mail_wapa
echo ' ' 
# Now we wait
echo "Waiting for derivation application to finish"
wait
echo 'Derivation application done, creating and transferring hydromet input file'
# now run the application to generate the hydromet input file
scadaData app_user uchdb2 `cat current_date`
echo ' '
#now set $1 to first field in this file
set `cat ./hydro_file`
echo ' '
echo "              Printing Hydromet data"
echo ' '
prp $1
echo ' '
echo ' '
echo "       Transferring data to Hydromet on the ALPHA"
echo ' '
# annoying stuff to deal with letter case 
# because NFS on slcalp does wierd things to conserve the case
# hydromet_##SEP.dat becomes HYDROMET_##$SEP.$DAT on vms
# so we handle it ahead of time the vms $ in the name indicates a case shift
u=`cat LChydro_file`

chmod ugo+rwx $1
scp -p $1 hydromet@zippy:scada_files/$u

#do we need to do this?
#ssh zippy -l hydromet "set sec [.scada_files]$u /prot=(s:rwed,o:rwed,g:rwed,w:re)"

#
# these commands below are the previous version, and are less efficient.
#
# now, we take advantage of the nfsmount on zimmy, and
# copy the file to the alpha directory as mounted on zimmy
#scp `cat dum` zimmy:/alpdata/archives/xferscada/$u
# now, login to the alpha and copy the file to where it needs to be
# this command complains that $U is not locked, but it is, so...
#ssh -1 slcalp -l hydromet 'pipe set def custom$:[archives.xferscada]'" && unlock $U && copy $U uc280:[hydromet.scada_files]"
#instead, do this command which just changes the protection on the file.
#ssh zippy -l hydromet "set sec [.scada_files]$U /prot=(s:rwed,o:rwed,g:rwed,w:re)"
# then, delete the copied file
#ssh zimmy "rm /alpdata/archives/xferscada/$u"
#done!
echo ' '
echo ' '
echo '              runtty_input script now complete'
echo ' ' 
echo '         Please report all errors seen in this script'
echo ' '
exit
